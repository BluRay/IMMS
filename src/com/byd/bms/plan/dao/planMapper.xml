<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.byd.bms.plan.dao.IPlanDao">

	<select id="checkImportPlanFactory" parameterType="Map" resultType="String">
		SELECT id FROM BMS_FACTORY_ORDER WHERE order_id = (SELECT
		id FROM BMS_ORDER WHERE order_no=#{order_no})
		AND factory_id = (SELECT
		id FROM BMS_BASE_FACTORY WHERE factory_name = #{factory_name})
		limit 1
	</select>
	
	<insert id="insertPlanMaster" useGeneratedKeys="true" keyProperty="id" parameterType="com.byd.bms.plan.model.PlanMasterPlan">
		INSERT INTO BMS_PLAN_MASTER_PLAN
		(version, order_id, factory_id, plan_code_id, plan_month, flag, D1, D2, D3, D4, D5, D6, D7, D8, D9, D10, D11, D12, D13, D14, D15, D16, D17, D18, D19, D20, D21, D22, D23, D24, D25, D26, D27, D28, D29, D30, D31, creator_id, create_date)
		VALUES(#{version}, (SELECT id FROM BMS_OR_ORDER WHERE order_no = #{order_no}), (SELECT id FROM BMS_BASE_FACTORY WHERE factory_name = #{factory_name}),
		(SELECT id FROM BMS_BASE_KEY WHERE key_code = 'PLAN_CODE' AND key_name = #{plan_code_keyname}),
		#{plan_month}, #{flag}, #{D1}, #{D2}, #{D3}, #{D4}, #{D5}, #{D6}, #{D7}, #{D8}, #{D9}, #{D10}, 
		#{D11}, #{D12}, #{D13}, #{D14}, #{D15}, #{D16}, #{D17}, #{D18}, #{D19}, #{D20}, 
		#{D21}, #{D22}, #{D23}, #{D24}, #{D25}, #{D26}, #{D27}, #{D28}, #{D29}, #{D30}, #{D31}, 
		#{creator_id}, #{create_date})
	</insert>
	
	<select id="getPlanMasterIndex" parameterType="Map" resultType="com.byd.bms.plan.model.PlanMasterIndex">
		SELECT DISTINCT
		m.version,o.order_no,f.factory_name,u.display_name,create_date FROM
		BMS_PLAN_MASTER_PLAN m
		LEFT JOIN BMS_OR_ORDER o ON m.order_id = o.id
		LEFT JOIN BMS_BASE_FACTORY f ON m.factory_id = f.id
		LEFT JOIN BMS_BASE_USER u ON m.creator_id = u.id where 1=1
		<if test="factory_id!=''">
			and m.factory_id = #{factory_id}
		</if>
		<if test="order_no!=''">
			and o.order_no like CONCAT('%',#{order_no},'%')
		</if>
		AND flag = '0'
		ORDER BY m.version DESC
		<if test="offset!=null">
			LIMIT #{start} ,#{length} 
		</if>
	</select>
	
	<select id="getPlanMasterList" parameterType="Map" resultType="com.byd.bms.plan.model.PlanMasterPlan">
		SELECT
		m.D1+m.D2+m.D3+m.D4+m.D5+m.D6+m.D7+m.D8+m.D9+m.D10+m.D11+m.D12+m.D13+m.D14+m.D15+m.D16+m.D17+m.D18+m.D19+m.D20+
		m.D21+m.D22+m.D23+m.D24+m.D25+m.D26+m.D27+m.D28+m.D29+m.D30+m.D31 AS
		sumQty, k.key_name AS plan_code_keyname, m.*,o.order_no,f.factory_name
		FROM BMS_PLAN_MASTER_PLAN m
		LEFT JOIN BMS_OR_ORDER o ON m.order_id = o.id
		LEFT JOIN BMS_BASE_FACTORY f ON
		m.factory_id = f.id
		LEFT JOIN
		BMS_BASE_KEY k ON m.plan_code_id=k.id
		where 1=1
		<if test="version!=''">
			AND version = #{version}
			AND flag = (SELECT MAX(flag+0)
			FROM
			BMS_PLAN_MASTER_PLAN WHERE version = #{version})
		</if>
		<if test="order_no!=''">
			and order_id = (SELECT id FROM BMS_OR_ORDER WHERE
			order_no=#{order_no})
			AND factory_id = #{factory_id}
			AND version =
			(SELECT MAX(version) FROM BMS_PLAN_MASTER_PLAN WHERE
			order_id =
			(SELECT id FROM BMS_OR_ORDER WHERE order_no=#{order_no}) AND
			factory_id =
			#{factory_id} AND plan_month=#{plan_month})
			AND flag =
			(SELECT
			MAX(flag+0) FROM BMS_PLAN_MASTER_PLAN WHERE version =(SELECT
			MAX(version) FROM BMS_PLAN_MASTER_PLAN WHERE order_id = (SELECT id
			FROM BMS_OR_ORDER WHERE order_no=#{order_no}) AND factory_id =
			#{factory_id} AND plan_month=#{plan_month}) AND
			plan_month=#{plan_month})
			AND plan_month=#{plan_month}
			ORDER BY version
			DESC,flag
			DESC,plan_month,plan_code_id
		</if>
	</select>
	
	<select id="getPlanIssed" parameterType="Map" resultType="Map">
		SELECT
		plan_code_id,plan_date FROM BMS_PLAN_PRODUCTION_PLAN
		WHERE order_id =
		(SELECT id FROM BMS_OR_ORDER WHERE order_no=#{order_no})
		AND factory_id =
		#{factory_id}
	</select>
	
	<insert id="insertMasterPlan" useGeneratedKeys="true" keyProperty="id" parameterType="com.byd.bms.plan.model.PlanMasterPlan">
		<![CDATA[
		insert into BMS_PLAN_MASTER_PLAN (
		version,order_id,factory_id,plan_code_id,plan_month,flag,D1,D2,D3,D4,D5,D6,D7,D8,D9,D10,D11,D12,D13,D14,D15,D16,D17,
		D18,D19,D20,D21,D22,D23,D24,D25,D26,D27,D28,D29,D30,D31,creator_id,create_date)
		values(
		#{version},(SELECT id FROM BMS_OR_ORDER WHERE order_no=#{order_no}),(SELECT id FROM BMS_BASE_FACTORY WHERE factory_name=#{factory_name}),
		(SELECT id FROM BMS_BASE_KEY WHERE key_code = 'PLAN_CODE' AND key_name = #{plan_code_keyname}),#{plan_month},#{flag},#{D1},#{D2},#{D3},#{D4},#{D5},#{D6},#{D7},
		#{D8},#{D9},#{D10},#{D11},#{D12},#{D13},#{D14},#{D15},#{D16},#{D17},#{D18},#{D19},#{D20},#{D21},#{D22},#{D23},#{D24},
		#{D25},#{D26},#{D27},#{D28},#{D29},#{D30},#{D31},#{creator_id},#{create_date})
		]]>
	</insert>
	
	<update id="updatePlanMasterInfo" parameterType="com.byd.bms.plan.model.PlanMasterPlan">
		<![CDATA[
		UPDATE BMS_PLAN_MASTER_PLAN SET version=#{version},order_id=#{order_id},factory_id=#{factory_id},plan_code_id=#{plan_code_id},plan_month=#{plan_month},
		flag=#{flag},D1=#{D1},D2=#{D2},D3=#{D3},D4=#{D4},D5=#{D5},D6=#{D6},D7=#{D7},D8=#{D8},D9=#{D9},D10=#{D10},D11=#{D11},
		D12=#{D12},D13=#{D13},D14=#{D14},D15=#{D15},D16=#{D16},D17=#{D17},D18=#{D18},D19=#{D19},D20=#{D20},D21=#{D21},D22=#{D22},
		D23=#{D23},D24=#{D24},D25=#{D25},D26=#{D26},D27=#{D27},D28=#{D28},D29=#{D29},D30=#{D30},D31=#{D31}
		WHERE id=#{id}
		]]>
	</update>
	
	<insert id="insertOperateChangeLog" useGeneratedKeys="true"
		keyProperty="id" parameterType="com.byd.bms.util.model.BmsBaseOperateChangeLog">
		<![CDATA[
		insert into BMS_BASE_OPERATE_CHANGE_LOG (
		operate_change_type_id,table_name,field_id,field_name,old_value,new_value,changer_id,change_date)
		VALUES(
		#{operate_change_type_id},#{table_name},#{field_id},#{field_name},#{old_value},#{new_value},#{changer_id},#{change_date})
		]]>
	</insert>
	
</mapper>
