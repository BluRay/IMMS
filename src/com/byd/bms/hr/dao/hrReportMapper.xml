<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.byd.bms.hr.dao.IHrReportDao">
  	
		
	<!-- 查询奖惩汇总信息 -->
	<select id="getRewardsCollectList" resultType="Map"
		parameterType='Map'>
		
		SELECT tmp.*,r.rewards_date,r.reasons,r.add as add_,r.deduct as deduct_,r.group_leader,r.gaffer,r.proposer,r.status 
			FROM 
					(SELECT
							r1.staff_number,s.name,s.workgroup_org,s.team_org,left(r1.rewards_date,7) rewards_month,r1.rewards_factory,r1.rewards_workshop,100
							AS 'fullmark',sum(r1.add) AS `add`,
							SUM(r1.deduct) AS
							deduct,100+ifnull(sum(r1.add),0)-ifnull(SUM(r1.deduct),0) AS mark
							 FROM
							BMS_HR_REWARDS r1
							LEFT JOIN BMS_HR_STAFF s ON r1.staff_number = s.staff_number
							WHERE
							1=1
							and r1.rewards_date LIKE CONCAT(#{rewards_date},'%') 
							<if test="rewards_factory!=null and rewards_factory!=''">
								AND r1.rewards_factory = #{rewards_factory}
							</if>
							<if test="rewards_workshop!=null and rewards_workshop!=''">
								AND FIND_IN_SET(r1.rewards_workshop,#{rewards_workshop})  >0 
							</if>
							<if test="staff_number!=null">
								AND r1.staff_number LIKE CONCAT('%',#{staff_number},'%') 
								AND (s.staff_number LIKE CONCAT('%',#{staff_number},'%') OR s.name LIKE CONCAT('%',#{staff_number},'%'))
							</if>
							GROUP BY r1.staff_number,left(r1.rewards_date,7),r1.rewards_factory,r1.rewards_workshop
							order by r1.staff_number,left(r1.rewards_date,7),r1.rewards_factory,r1.rewards_workshop
							<if test="start !=null  and length!=-1">
								LIMIT #{start} ,#{length} 
							</if>
							)tmp  
		    LEFT JOIN BMS_HR_REWARDS r 
				ON tmp.staff_number = r.staff_number AND tmp.rewards_month = left(r.rewards_date,7) 
					AND tmp.rewards_factory = r.rewards_factory AND tmp.rewards_workshop = r.rewards_workshop 
			LEFT JOIN BMS_HR_STAFF s1 ON r.staff_number = s1.staff_number
		 WHERE 1=1 
					and	r.rewards_date LIKE CONCAT(#{rewards_date},'%')
				<if test="rewards_factory!=null and rewards_factory!=''">
					AND r.rewards_factory = #{rewards_factory}
				</if>
				<if test="rewards_workshop!=null and rewards_workshop!=''">
					AND FIND_IN_SET(r.rewards_workshop,#{rewards_workshop})  >0 
				</if>
				<if test="staff_number!=null">
					AND r.staff_number LIKE CONCAT('%',#{staff_number},'%') 
					AND (s1.staff_number LIKE CONCAT('%',#{staff_number},'%') OR s1.name LIKE CONCAT('%',#{staff_number},'%'))
				</if>
				ORDER BY r.staff_number,tmp.rewards_month,tmp.rewards_factory,tmp.rewards_workshop
	</select>
	<select id="getRewardsCollectTotalCount" resultType="int"
		parameterType='Map'>
		SELECT 		count(tmp.staff_number)  FROM (
				SELECT r.staff_number FROM BMS_HR_REWARDS r
				LEFT JOIN BMS_HR_STAFF s ON r.staff_number = s.staff_number
				WHERE  1= 1
				and r.rewards_date LIKE CONCAT('%',#{rewards_date},'%')
				<if test="rewards_factory!=null and rewards_factory!=''">
					AND r.rewards_factory = #{rewards_factory}
				</if>
				<if test="rewards_workshop!=null and rewards_workshop!=''">
					AND FIND_IN_SET(r.rewards_workshop,#{rewards_workshop})  >0 
				</if>
				<if test="staff_number!=null">
					AND r.staff_number LIKE CONCAT('%',#{staff_number},'%') 
					AND (s.staff_number LIKE CONCAT('%',#{staff_number},'%') OR s.name LIKE CONCAT('%',#{staff_number},'%'))
				</if>
				GROUP BY r.staff_number,left(r.rewards_date,7),r.rewards_factory,r.rewards_workshop )tmp

	</select>
	
	<select id="queryStaffPieceHours" parameterType="Map" resultType="Map">
		<if test="salary_model=='技能系数' or salary_model=='承包制' or salary_model=='自制件承包'">
		select a.*,c.total_ppay,
		<if test="count_flag=='车辆维度'">
		b.bus_total
		</if>
		<if test="count_flag=='人员维度'">
		b.staff_total
		</if>
		from(
			select ps.*,concat(o.order_no,o.order_name,t.bus_type_code,' ',o.order_qty,'台') order_desc
			from BMS_HR_PIECE_SALARY ps
			left join BMS_OR_ORDER o on ps.order_id=o.id
			left join BMS_BASE_BUS_TYPE t on t.id=o.bus_type_id
			where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.salary_model=#{salary_model} 
			<if test="workgroup !=null and workgroup !='全部'">
				and ps.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ps.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="bus_number !=null and bus_number !=''">
				and ps.bus_number like concat('%',#{bus_number},'%')
			</if>
			<if test="order_id !=null and order_id !=''">
				and ps.order_id=#{order_id}
			</if>
			<if test="order_no !=null and order_no !=''">
				and o.order_no like concat('%',#{order_no},'%')
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and ps.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and ps.work_date&lt;=#{wdate_end}
			</if>) a
		join
			(select 
			<if test="count_flag=='车辆维度'">
			count(distinct ps1.bus_number) bus_total 
			</if>
			<if test="count_flag=='人员维度'">
			count(distinct ps1.staff_number) staff_total 
			</if>
			from BMS_HR_PIECE_SALARY ps1 
			where ps1.factory=#{factory} and ps1.workshop=#{workshop} and ps1.salary_model=#{salary_model} 
			<if test="workgroup !=null and workgroup !='全部'">
				and ps1.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ps1.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ps1.staff_number like concat('%',#{staff},'%') or ps1.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="bus_number !=null and bus_number !=''">
				and ps1.bus_number like concat('%',#{bus_number},'%')
			</if>
			<if test="order_id !=null and order_id !=''">
				and ps1.order_id=#{order_id}
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and ps1.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and ps1.work_date&lt;=#{wdate_end}
			</if>) b
		left join
			(select round(sum(p.ppay),2) total_ppay,p.factory,p.workshop,p.workgroup,p.team,p.bus_number 
			from BMS_HR_PIECE_SALARY p 
			where p.factory=#{factory} and p.workshop=#{workshop} and p.salary_model=#{salary_model} 
			<if test="workgroup !=null and workgroup !='全部'">
				and p.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and p.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (p.staff_number like concat('%',#{staff},'%') or p.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="bus_number !=null and bus_number !=''">
				and p.bus_number like concat('%',#{bus_number},'%')
			</if>
			<if test="order_id !=null and order_id !=''">
				and p.order_id=#{order_id}
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and p.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and p.work_date&lt;=#{wdate_end}
			</if> 
			group by p.bus_number,p.factory,p.workshop,p.workgroup,p.team) c 
		on a.factory=c.factory and a.workshop=c.workshop and a.workgroup=c.workgroup and a.team=c.team and a.bus_number=c.bus_number
		
			<if test="count_flag=='车辆维度'">
				order by a.work_date,a.bus_number,a.team
			</if>	
			<if test="count_flag=='人员维度'">
				order by a.staff_number,a.work_date
			</if>
		
			<if test="start !=null and length !='-1' ">
			LIMIT #{start} ,#{length} 
			</if>	
		</if>
		
		<if test="salary_model=='辅助人力'">
		select h.*,s.name staff_name,s.job,s.basic_salary,ps.ppay,concat(o.order_no,o.order_name,t.bus_type_code,' ',o.order_qty,'台') order_desc,
		(select round(sum(p.ppay),2) from BMS_HR_PIECE_SALARY p where p.factory=h.factory and p.workshop=h.workshop
		and p.workgroup=h.workgroup and p.team=h.team
		<if test="count_flag=='订单维度'">
			and p.order_id=ps.order_id  
		</if>	
		<if test="count_flag=='人员维度'">
			and p.staff_number=h.staff_number 
		</if>	
		and locate(substring(#{wdate_start},1,7),p.work_date)>0 and p.salary_model=#{salary_model}) as total_ppay
		from BMS_HR_STAFF_PIECE_HOURS h
		left join BMS_OR_ORDER o on h.order_id=o.id
		left join BMS_BASE_BUS_TYPE t on t.id=o.bus_type_id
		left join BMS_HR_PIECE_SALARY ps 
		on ps.salary_model=#{salary_model} and h.staff_number=ps.staff_number and h.factory=ps.factory
		and h.workshop=ps.workshop and h.workgroup=ps.workgroup and h.team=ps.team and locate(ps.work_date,h.work_date)>0 and h.order_id=ps.order_id
		left join BMS_HR_STAFF s on s.staff_number=h.staff_number
		where h.factory=#{factory} and h.workshop=#{workshop} and h.salary_model=#{salary_model}
		<if test="workgroup !=null and workgroup !='全部'">
				and h.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and h.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (h.staff_number like concat('%',#{staff},'%') or s.name like concat('%',#{staff},'%') ) 
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and h.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and h.work_date&lt;=#{wdate_end}
			</if>
			<if test="order_id !=null and order_id !=''">
				and h.order_id=#{order_id}
			</if>
			<if test="count_flag=='订单维度'">
				order by h.order_id,h.work_date,h.factory,h.workshop,h.workgroup,h.team
			</if>	
			<if test="count_flag=='人员维度'">
				order by h.staff_number,h.work_date
			</if>
			<if test="start !=null and length !='-1' ">
				LIMIT #{start} ,#{length} 
			</if>
		</if>
		
		<if test="salary_model=='底薪模式'">
		select h.*,s.name staff_name,s.job,s.basic_salary,ps.ppay,
		(select round(sum(p.ppay),2) from BMS_HR_PIECE_SALARY p where p.factory=h.factory and p.workshop=h.workshop
		and p.workgroup=h.workgroup and p.team=h.team
		<if test="count_flag=='日期维度'">
			and p.work_date=ps.work_date 
		</if>	
		<if test="count_flag=='人员维度'">
			and p.staff_number=h.staff_number 
		</if>	
		and locate(substring(#{wdate_start},1,7),p.work_date)>0 and p.salary_model=#{salary_model}) as total_ppay
		from BMS_HR_STAFF_PIECE_HOURS h
		left join BMS_HR_PIECE_SALARY ps on ps.salary_model=#{salary_model} and h.staff_number=ps.staff_number and h.factory=ps.factory
			and h.workshop=ps.workshop and h.workgroup=ps.workgroup and h.team=ps.team and locate(ps.work_date,h.work_date)>0
		left join BMS_HR_STAFF s on s.staff_number=h.staff_number
		where h.factory=#{factory} and h.workshop=#{workshop} and h.salary_model=#{salary_model}
		<if test="workgroup !=null and workgroup !='全部'">
				and h.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and h.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (h.staff_number like concat('%',#{staff},'%') or s.name like concat('%',#{staff},'%') ) 
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and h.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and h.work_date&lt;=#{wdate_end}
			</if>
			<if test="count_flag=='日期维度'">
				order by h.work_date,h.factory,h.workshop,h.workgroup,h.team
			</if>	
			<if test="count_flag=='人员维度'">
				order by h.staff_number,h.work_date
			</if>
			<if test="start !=null and length !='-1' ">
				LIMIT #{start} ,#{length} 
			</if>
		</if>
		
	</select>
	
	<select id="queryStaffPieceHoursCount" parameterType="Map" resultType="int">
		<if test="salary_model=='技能系数' or salary_model=='承包制' or salary_model=='自制件承包'">
		select count(ps.id)
		from BMS_HR_PIECE_SALARY ps
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.salary_model=#{salary_model}
			<if test="workgroup !=null and workgroup !='全部'">
				and ps.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ps.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="bus_number !=null and bus_number !=''">
				and ps.bus_number like concat('%',#{bus_number},'%')
			</if>
			<if test="order_id !=null and order_id !=''">
				and ps.order_id=#{order_id}
			</if>
			<if test="order_no !=null and order_no !=''">
				and o.order_no like concat('%',#{order_no},'%')
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and ps.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and ps.work_date&lt;=#{wdate_end}
			</if>
		</if>
		
		<if test="salary_model=='辅助人力' or salary_model=='底薪模式'">
		select count(h.id)
		from BMS_HR_STAFF_PIECE_HOURS h		
		left join BMS_HR_STAFF s on s.staff_number=h.staff_number
		where h.factory=#{factory} and h.workshop=#{workshop} and h.salary_model=#{salary_model}
		<if test="workgroup !=null and workgroup !='全部'">
				and h.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and h.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (h.staff_number like concat('%',#{staff},'%') or s.name like concat('%',#{staff},'%') ) 
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and h.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and h.work_date&lt;=#{wdate_end}
			</if>
		</if>
	</select>
	
	<select id="queryStaffPieceSalary" parameterType="Map" resultType="Map">
		select st.*,s.job,s.plant_org,s.workshop_org,s.workgroup_org,s.team_org,round(sum(ps.ppay),2) piece_pay_total,
		sum(case when ps.distribution >0 then ps.bus_count else 0 end) piece_total,
		sum(ps.bonus) bonus_total,ps.salary_model,
		(select round(sum(ws.wpay),2) from BMS_HR_WAIT_SALARY ws 
		where ws.staff_number=st.staff_number and ws.factory=#{factory}  and ws.workshop=#{workshop} 
		and ws.work_date like concat(#{month},'%')) wait_pay_total,
		(select round(sum(ws.work_hour),2) from BMS_HR_WAIT_SALARY ws 
		where ws.staff_number=st.staff_number and ws.factory=#{factory}  and ws.workshop=#{workshop} 
		and ws.work_date like concat(#{month},'%')) wwh_total,
		(select round(sum(ts.real_work_hour*ts.hour_price),2) from BMS_HR_TMP_SALARY ts 
		where ts.factory=#{factory} and ts.workshop=#{workshop} 
		and ts.staff_number=st.staff_number and ts.work_date like concat(#{month},'%')) tmp_pay_total,
		(select round(sum(ts.real_work_hour),4) from BMS_HR_TMP_SALARY ts 
		where ts.factory=#{factory} and ts.workshop=#{workshop} 
		and ts.staff_number=st.staff_number and ts.work_date like concat(#{month},'%')) tmpwh_total,
		(select round(sum(es.real_work_hour*es.hour_price),2) from BMS_HR_TECH_SALARY es 
		where es.factory=#{factory} and es.workshop=#{workshop} 
		and es.staff_number=st.staff_number and es.work_date like concat(#{month},'%')) ecn_pay_total,
		(select round(sum(es.real_work_hour),4) from BMS_HR_TECH_SALARY es 
		where es.factory=#{factory} and es.workshop=#{workshop} 
		and es.staff_number=st.staff_number and es.work_date like concat(#{month},'%')) ecnwh_total,
		(select round(sum(r.add-r.deduct),1) from BMS_HR_REWARDS r where r.staff_number=st.staff_number and r.rewards_date like concat(#{month},'%') ) dscore_total,
		(select sum(r.add-r.deduct)*5 from BMS_HR_REWARDS r where r.staff_number=st.staff_number and r.rewards_date like concat(#{month},'%') ) deduct_pay_total,
		s.status,a.attendance_days,a.attendance_hours,ss.pre_sale_salary,ss.after_sale_salary,ss.support_salary,ss.hourly_salary,ss.holiday_salary,ss.paid_leave_salary,ss.specical_salary,		
		<choose>	
		<when test="workshop=='自制件'">
		(select sum(s.quantity) qty
		from BMS_PD_WORKSHOP_SUPPLY s
		left join BMS_BASE_FACTORY f ON s.factory_id=f.id
		where supply_workshop='自制件' and receive_workshop='部件' 
		and substring(s.supply_date,1,7)=#{month} and f.factory_name=#{factory}) as output
		</when>
		<when test="workshop=='部件'">
		(select sum(pf.online_plan_qty)
		from BMS_PD_PARTS_PLAN_FINISH pf
		left join BMS_BASE_FACTORY f ON pf.factory_id=f.id
		left join BMS_BASE_KEY k on k.value=pf.parts_id and k.key_code='BASE_PARTS'
		where substring(pf.prod_date,1,7)=#{month} and k.key_name='喷砂' and f.factory_name=#{factory}) as output
		</when>	
		<when test="workshop=='焊装'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.welding_offline_date,1,7)=#{month}) as output
		</when>
		<when test="workshop=='涂装'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.painting_offline_date,1,7)=#{month}) as output
		</when>
		<when test="workshop=='底盘'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.chassis_offline_date,1,7)=#{month}) as output
		</when>
		<when test="workshop=='总装'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.assembly_offline_date,1,7)=#{month}) as output
		</when>
		<otherwise>'' as output</otherwise>
		</choose>
		from(
		select distinct ps.staff_number,ps.staff_name
		from BMS_HR_PIECE_SALARY ps
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ps.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ps.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ws.staff_number,ws.staff_name
		from BMS_HR_WAIT_SALARY ws
		where ws.factory=#{factory} and ws.workshop=#{workshop}  and ws.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ws.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ws.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ts.staff_number,ts.staff_name
		from BMS_HR_TMP_SALARY ts
		where ts.factory=#{factory} and ts.workshop=#{workshop} and ts.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ts.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ts.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ts.staff_number like concat('%',#{staff},'%') or ts.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct es.staff_number,es.staff_name
		from BMS_HR_TECH_SALARY es
		where es.factory=#{factory} and es.workshop=#{workshop} and es.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and es.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and es.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (es.staff_number like concat('%',#{staff},'%') or es.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct s1.staff_number,s1.name staff_name
		from BMS_HR_STAFF s1
		where s1.plant_org=#{factory} and s1.workshop_org=#{workshop} and s1.salary_type='计件' 
		and (s1.status='在职' or (s1.status='离职' and DATE_FORMAT(s1.leave_date, '%Y-%m-%d') >=concat(#{month},'-01')))
		<if test="workgroup !=null and workgroup !='全部'">
			and s1.workgroup_org=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and s1.team_org=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (s1.staff_number like concat('%',#{staff},'%') or s1.name like concat('%',#{staff},'%') )
		</if>
		) st
		left join BMS_HR_STAFF s on s.staff_number=st.staff_number
		left join BMS_HR_PIECE_SALARY ps on ps.factory=#{factory} and ps.workshop=#{workshop} 
		and st.staff_number=ps.staff_number and ps.work_date like concat(#{month},'%')		
		left join BMS_HR_STAFF_ATTENDANCE a on a.staff_number=st.staff_number and a.month=#{month}
		left join BMS_HR_SPECIAL_SALARY ss on ss.staff_number=st.staff_number and ss.submit_factory=#{factory} and ss.submit_workshop=#{workshop} and ss.month = #{month} 
		group by staff_number
		order by workgroup_org,team_org,salary_model
	</select>
	
	<select id="queryStaffPieceSalaryHistory" parameterType="Map" resultType="Map">
		select s.status staff_status,sh.*
		from BMS_HR_PIECE_SALARY_HISTORY sh
		left join (
		select distinct ps.staff_number,ps.staff_name
		from BMS_HR_PIECE_SALARY ps
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ps.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ps.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ws.staff_number,ws.staff_name
		from BMS_HR_WAIT_SALARY ws
		where ws.factory=#{factory} and ws.workshop=#{workshop}  and ws.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ws.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ws.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ts.staff_number,ts.staff_name
		from BMS_HR_TMP_SALARY ts
		where ts.factory=#{factory} and ts.workshop=#{workshop} and ts.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ts.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ts.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ts.staff_number like concat('%',#{staff},'%') or ts.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct es.staff_number,es.staff_name
		from BMS_HR_TECH_SALARY es
		where es.factory=#{factory} and es.workshop=#{workshop} and es.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and es.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and es.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (es.staff_number like concat('%',#{staff},'%') or es.staff_name like concat('%',#{staff},'%') )
		</if>
		) st on st.staff_number=sh.staff_number
		left join BMS_HR_STAFF s on s.staff_number=sh.staff_number
		where sh.month=#{month} and sh.submit_factory=#{factory} and sh.submit_workshop=#{workshop} 
		and (s.status='在职' or (s.status='离职' and DATE_FORMAT(s.leave_date, '%Y-%m-%d') >=concat(#{month},'-01')))
		<if test="staff !=null and staff !=''">
		and (st.staff_number like concat('%',#{staff},'%') or st.staff_name like concat('%',#{staff},'%') )
		</if>
	
	</select>
	
	<select id="queryStaffPieceSalaryToBal" parameterType="Map" resultType="Map">
		select s.status staff_status,sh.*
		from BMS_HR_PIECE_SALARY_HISTORY sh
		left join BMS_HR_STAFF s on s.staff_number=sh.staff_number
		where sh.month=#{month} and s.plant_org=#{factory} and s.workshop_org=#{workshop} 
		and (s.status='在职' or (s.status='离职' and DATE_FORMAT(s.leave_date, '%Y-%m-%d') >=concat(#{month},'-01')))
		<if test="workgroup !=null and workgroup !='全部'">
		 and s.workgroup_org=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
		 and s.team_org=#{team}
		</if>
		<if test="staff !=null and staff !=''">
		and (s.staff_number like concat('%',#{staff},'%') or s.staff_name like concat('%',#{staff},'%') )
		</if>
	
	</select>
	
	<insert id="saveSubmitStaffSalary" parameterType="Map" >
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		insert into BMS_HR_PIECE_SALARY_HISTORY 
		(month,staff_number,staff_name,job,plant_org,workshop_org,workgroup_org,team_org,
		attendance_days,attendance_hours,piece_total,bonus_total,piece_pay_total,ecnwh_total,ecn_pay_total,wwh_total,wait_pay_total,tmpwh_total,tmp_pay_total,
		dscore_total,deduct_pay_total,pre_sale_salary,after_sale_salary,paid_leave_salary,holiday_salary,specical_salary,hourly_salary,support_salary,
		saver,save_date,submit_factory,submit_workshop,status,production_qty
		) 
		values 
		<foreach collection="staff_salary_list" item="detail" index="index" separator=",">
		(#{month},#{detail.staff_number},#{detail.staff_name},#{detail.job},#{detail.plant_org},#{detail.workshop_org},#{detail.workgroup_org},#{detail.team_org},#{detail.attendance_days},#{detail.attendance_hours},
		#{detail.piece_total},#{detail.bonus_total},#{detail.piece_pay_total},#{detail.ecnwh_total},#{detail.ecn_pay_total},#{detail.wwh_total},#{detail.wait_pay_total},#{detail.tmpwh_total},#{detail.tmp_pay_total},
		#{detail.dscore_total},#{detail.deduct_pay_total},#{detail.pre_sale_salary},#{detail.after_sale_salary},#{detail.paid_leave_salary},#{detail.holiday_salary},#{detail.specical_salary},#{detail.hourly_salary},#{detail.support_salary},
		#{saver},#{save_date},#{factory},#{workshop},'已提交',#{detail.output}
		)
		</foreach>
	</insert>
	
	<select id="getEcnReportData" parameterType="Map" resultType="Map">
		SELECT tech_order_no,task_content,workshop,total_hours AS totalhours,round(total_hours*hour_price,2) AS totalprice,
		work_date,staff_number,staff_name,job,workshop_org,workgroup_org,team_org,round(work_hour,4) AS work_hour,
		round(hour_price*real_work_hour,4) AS salary,plant_org,round(real_work_hour,4) AS real_work_hour
		FROM BMS_HR_TECH_SALARY
		WHERE
		1=1
		<if test="factory !=null and factory !=''">
			and factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and find_in_set(workshop,#{workshop})>0
		</if>
		<if test="workgroup !=null and workgroup !=''">
			and workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !=''">
			and team=#{team}
		</if>
		<if test="dateStart !=null and dateStart !=''">
			<![CDATA[
			and work_date>=#{dateStart}
			]]>
		</if>
		<if test="dateEnd !=null and dateEnd !=''">
			<![CDATA[
			and work_date<=#{dateEnd}
			]]>
		</if>
		<if test="staff !=null and staff !=''">
			<![CDATA[
			and (staff_number like CONCAT('%',#{staff},'%') or staff_name like CONCAT('%',#{staff},'%'))
			]]>
		</if>
		<if test="ecn_document_number !=null and ecn_document_number !=''">
			<![CDATA[
			and tech_order_no like CONCAT('%',#{ecn_document_number},'%')
			]]>
		</if>
		<if test="task !=null and task !=''">
			<![CDATA[
			and task_content like CONCAT('%',#{task},'%')
			]]>
		</if>
		order by
		tech_order_no asc,
		work_date asc
	</select>
	<!-- 获技改工时统计list人员维度 -->
	<select id="getEcnReportData1" parameterType="Map" resultType="Map">
		select distinct tech_order_no,CONCAT(task_id,'.',task_content) as task,total_hours AS totalhours,
		total_hours*hour_price as totalprice,work_date,staff_number,staff_name,job,workshop_org,workgroup_org,team_org,
		round(work_hour,4) as work_hour,round(hour_price*real_work_hour,4) AS salary,plant_org,round(real_work_hour,4) as real_work_hour
		from BMS_HR_TECH_SALARY
		where 1=1
		<if test="factory !=null and factory !=''">
			and factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and find_in_set(workshop,#{workshop})>0
		</if>
		<if test="workgroup !=null and workgroup !=''">
			and workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !=''">
			and team=#{team}
		</if>
		<if test="dateStart !=null and dateStart !=''">
			<![CDATA[
			and work_date>=#{dateStart}
			]]>
		</if>
		<if test="dateEnd !=null and dateEnd !=''">
			<![CDATA[
			and work_date<=#{dateEnd}
			]]>
		</if>
		<if test="staff !=null and staff !=''">
			<![CDATA[
			and (staff_number like CONCAT('%',#{staff},'%') or staff_name like CONCAT('%',#{staff},'%'))
			]]>
		</if>
		<if test="ecn_document_number !=null and ecn_document_number !=''">
			<![CDATA[
			and tech_order_no like CONCAT('%',#{ecn_document_number},'%')
			]]>
		</if>
		<if test="task !=null and task !=''">
			<![CDATA[
			and task_content like CONCAT('%',#{task},'%')
			]]>
		</if>
		order by
		staff_number asc,
		task asc,
		work_date asc
	</select>
	<select id="getTmpReportData" parameterType="Map" resultType="Map">
		select distinct O.tmp_order_no,S.total_hours as totalhours,S.total_hours*S.hour_price as totalprice,
		S.work_date,S.staff_number,S.staff_name,S.job,S.workshop_org,S.workgroup_org,S.team_org,S.reason_content,
		round(S.work_hour,2) as work_hour,round(S.hour_price*S.real_work_hour,2) as salary,
		S.plant_org,round(S.real_work_hour,2) as real_work_hour
		from BMS_HR_TMP_SALARY S
		LEFT OUTER JOIN BMS_PD_TMP_ORDER O ON S.order_id = O.id
		where
		1=1
		<if test="task !=null and task !=''">
			and O.tmp_order_no LIKE CONCAT('%',#{task},'%') 
		</if>
		<if test="factory !=null and factory !=''">
			and S.factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and find_in_set(S.workshop,#{workshop})>0
		</if>
		<if test="workgroup !=null and workgroup !=''">
			and S.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !=''">
			and S.team=#{team}
		</if>
		<if test="dateStart !=null and dateStart !=''">
			<![CDATA[
			and S.work_date>=#{dateStart}
			]]>
		</if>
		<if test="dateEnd !=null and dateEnd !=''">
			<![CDATA[
			and S.work_date<=#{dateEnd}
			]]>
		</if>
		<if test="staff !=null and staff !=''">
			<![CDATA[
			and (S.staff_number like CONCAT('%',#{staff},'%') or S.staff_name like CONCAT('%',#{staff},'%'))
			]]>
		</if>
		<if test="reason_content !=null and reason_content !=''">
			<![CDATA[
			and (S.reason_content like CONCAT('%',#{reason_content},'%') OR O.tmp_order_no like CONCAT('%',#{reason_content},'%'))
			]]>
		</if>
		ORDER BY
		O.tmp_order_no desc,
		S.work_date asc
	</select>
	<select id="getTmpReportData1" parameterType="Map" resultType="Map">
		select distinct O.tmp_order_no tmp_order_num,S.total_hours as totalhours,S.total_hours*S.hour_price as totalprice,
		S.work_date,S.staff_number,S.staff_name,S.job,S.workshop_org,S.workgroup_org,S.team_org,S.skill_parameter,
		round(S.work_hour,2) as work_hour,
		round(S.hour_price*S.real_work_hour,2) as salary,S.plant_org,round(S.real_work_hour,2) as real_work_hour
		from BMS_HR_TMP_SALARY S
		LEFT OUTER JOIN BMS_PD_TMP_ORDER O ON S.order_id = O.id
		where 1=1
		<if test="factory !=null and factory !=''">
			and S.factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and find_in_set(S.workshop,#{workshop})>0
		</if>
		<if test="workgroup !=null and workgroup !=''">
			and S.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !=''">
			and S.team=#{team}
		</if>
		<if test="dateStart !=null and dateStart !=''">
			<![CDATA[
			and S.work_date>=#{dateStart}
			]]>
		</if>
		<if test="dateEnd !=null and dateEnd !=''">
			<![CDATA[
			and S.work_date<=#{dateEnd}
			]]>
		</if>
		<if test="staff !=null and staff !=''">
			<![CDATA[
			and (S.staff_number like CONCAT('%',#{staff},'%') or S.staff_name like CONCAT('%',#{staff},'%'))
			]]>
		</if>
		<if test="reason_content !=null and reason_content !=''">
			<![CDATA[
			and S.reason_content like CONCAT('%',#{reason_content},'%')
			]]>
		</if>
		order by
		S.staff_number asc,
		S.work_date asc
	</select>
	
	<select id="queryBalanceSalaryCount" parameterType="Map" resultType="int">
		select count(id) from BMS_HR_PIECE_SALARY_HISTORY sh
		where sh.status in ('已提交','已驳回')
		<if test="factory !=null and factory !=''">
			and sh.submit_factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and sh.submit_workshop=#{workshop}
		</if>
		<foreach collection="staff_salary_list" item="detail" open=" and sh.staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and sh.month=#{month}
		</if>
		
	</select>
	
	<select id="queryBalanceStaffSalary" parameterType="Map" resultType="Map">
		select sh.staff_number,sh.submit_factory,sh.submit_workshop,sh.month from BMS_HR_PIECE_SALARY_HISTORY sh
		where sh.status = '已结算'
		<if test="factory !=null and factory !=''">
			and sh.submit_factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and sh.submit_workshop=#{workshop}
		</if>
		<foreach collection="staff_salary_list" item="detail" open=" and sh.staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and sh.month=#{month}
		</if>
		
	</select>
	
	<delete id="deletePieceSalaryHistory" parameterType="Map">
		delete from BMS_HR_PIECE_SALARY_HISTORY where status in ('已提交','已驳回')
		<if test="factory !=null and factory !=''">
			and submit_factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and submit_workshop=#{workshop}
		</if>
		<foreach collection="staff_salary_list" item="detail" open=" and staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and month=#{month}
		</if>
	</delete>
	<select id="queryStaffWaitHours" parameterType="Map" resultType="Map">
		select * from BMS_HR_WAIT_SALARY ws where status in ('1','3') and 1=1
		    <if test="factory !=null and factory !='全部'">
				and ws.factory=#{factory}
			</if>
			<if test="workshop !=null and workshop !='全部'">
				and ws.workshop=#{workshop}
			</if>
			<if test="workgroup !=null and workgroup !='全部'">
				and ws.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ws.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="waitdate !=null and waitdate !=''">
				and ws.work_date LIKE CONCAT('%',#{waitdate},'%')
			</if>
			<if test="start !=null and length !='-1' ">
				LIMIT #{start} ,#{length} 
			</if>	
	</select>
	
	<select id="queryStaffWaitHoursCount" parameterType="Map" resultType="int">
		select count(1) from BMS_HR_WAIT_SALARY ws where status in ('1','3') and 1=1
	    <if test="factory !=null and factory !='全部'">
			and ws.factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !='全部'">
			and ws.workshop=#{workshop}
		</if>
		<if test="workgroup !=null and workgroup !='全部'">
			and ws.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ws.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') ) 
		</if>
		<if test="waitdate !=null and waitdate !=''">
			and ws.work_date LIKE CONCAT('%',#{waitdate},'%')
		</if>
	</select>
	<update id="updateStaffSalaryStatus" parameterType="Map">
		update BMS_HR_PIECE_SALARY_HISTORY set status=#{status},calculator=#{saver},calculate_date=#{save_date}
		where submit_factory=#{factory} and submit_workshop=#{workshop}
		<foreach collection="staff_salary_list" item="detail" open=" and staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and month=#{month}
		</if>
	</update>
	
	<insert id="saveAttendanceReport" parameterType="List">
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		insert into BMS_HR_ATTENDENCE_REPORT (factory,workshop,team,direct_num_yd,direct_num_sd,short_num_yd,short_num_sd,assist_num_yd,
		assist_num_sd,leave_num,holiday_num,absence_num,trip_num,callout_num,out_aid_num,work_num,out_aid_cs_num,out_aid_nj_num,
		out_aid_hz_num,out_aid_dl_num,out_aid_qd_num,out_aid_cd_num,out_aid_wh_num,out_aid_sw_num,out_aid_ty_num,out_aid_sz_num,out_aid_xa_num,out_aid_nb_num,out_aid_yc_num,		
		out_aid_tj_num,out_aid_oth_num,out_aid_note,in_aid_cs_num,in_aid_nj_num,in_aid_hz_num,in_aid_dl_num,in_aid_qd_num,in_aid_cd_num,
		in_aid_wh_num,in_aid_sw_num,in_aid_ty_num,in_aid_sz_num,in_aid_xa_num,in_aid_nb_num,in_aid_yc_num,in_aid_tj_num,in_aid_oth_num,in_aid_note,record_date,report_type,editor_id,edit_date)
		values
		<foreach collection="list" item="detail" index="index" separator=",">
			(#{detail.factory},#{detail.workshop},#{detail.team},#{detail.direct_num_yd},#{detail.direct_num_sd},#{detail.short_num_yd},#{detail.short_num_sd},#{detail.assist_num_yd},#{detail.assist_num_sd},
			#{detail.leave_num},#{detail.holiday_num},#{detail.absence_num},#{detail.trip_num},#{detail.callout_num},#{detail.out_aid_num},#{detail.work_num},#{detail.out_aid_cs_num},#{detail.out_aid_nj_num},
			#{detail.out_aid_hz_num},#{detail.out_aid_dl_num},#{detail.out_aid_qd_num},#{detail.out_aid_cd_num},#{detail.out_aid_wh_num},#{detail.out_aid_sw_num},#{detail.out_aid_ty_num},#{detail.out_aid_sz_num},
			#{detail.out_aid_xa_num},#{detail.out_aid_nb_num},#{detail.out_aid_yc_num},
			#{detail.out_aid_tj_num},#{detail.out_aid_oth_num},#{detail.out_aid_note},#{detail.in_aid_cs_num},#{detail.in_aid_nj_num},#{detail.in_aid_hz_num},#{detail.in_aid_dl_num},#{detail.in_aid_qd_num},
			#{detail.in_aid_cd_num},#{detail.in_aid_wh_num},#{detail.in_aid_sw_num},#{detail.in_aid_ty_num},#{detail.in_aid_sz_num},
			#{detail.in_aid_xa_num},#{detail.in_aid_nb_num},#{detail.in_aid_yc_num},#{detail.in_aid_tj_num},#{detail.in_aid_oth_num},#{detail.in_aid_note},
			#{detail.record_date},#{detail.report_type},#{detail.editor_id},#{detail.edit_date})
		</foreach>
	</insert>
	
	<update id="deleteAttendanceReport" parameterType="Map">
		delete from BMS_HR_ATTENDENCE_REPORT where factory=#{factory} and workshop=#{workshop} and record_date=#{record_date} and report_type=#{report_type}
	</update>
	
	<select id="queryAttendanceDetailData" parameterType="Map" resultType="Map">
		select * from BMS_HR_ATTENDENCE_REPORT where 1=1
		<if test="factory !=null and factory !=''">
			and factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !='全部'">
			and workshop =#{workshop}
		</if>
		<if test="record_date !=null and record_date !=''">
			and record_date = #{record_date}
		</if>
			and report_type=#{report_type}
			order by factory,workshop
	</select>
	
	<select id="queryOrgInfo" parameterType="Map" resultType="Map">
		select o.id org_id
		from BMS_BASE_ORG o
		left join BMS_BASE_ORG o1 on o1.parent_id=o.id
		<if test="team !=null and team !=''">
		left join BMS_BASE_ORG o2 on o2.parent_id=o1.id
		</if>		
		where 1=1 and o1.name=#{workshop} and o.name=#{factory} 
		<if test="team !=null and team !=''">
			and o2.name=#{team}
		</if>
		limit 1
	</select>
	
	<select id="queryAttendanceReportData" parameterType="Map" resultType="Map">
		SELECT factory,workshop,record_date,sum(ifnull(direct_num_yd,0)) direct_num_yd,sum(ifnull(direct_num_sd,0)) direct_num_sd,
		sum(ifnull(short_num_yd,0)) short_num_yd,sum(ifnull(short_num_sd,0)) short_num_sd,sum(ifnull(leave_num,0)) leave_num,sum(ifnull(holiday_num,0)) holiday_num,
		sum(ifnull(absence_num,0)) absence_num,sum(ifnull(trip_num,0)) trip_num,sum(ifnull(out_aid_num,0)) out_aid_num,sum(ifnull(work_num,0)) work_num,
		sum(ifnull(out_aid_cs_num,0)) out_aid_cs_num,sum(ifnull(out_aid_nj_num,0)) out_aid_nj_num,sum(ifnull(out_aid_hz_num,0)) out_aid_hz_num,sum(ifnull(out_aid_dl_num,0)) out_aid_dl_num,
		sum(ifnull(out_aid_qd_num,0)) out_aid_qd_num,sum(ifnull(out_aid_cd_num,0)) out_aid_cd_num,sum(ifnull(out_aid_wh_num,0)) out_aid_wh_num,sum(ifnull(out_aid_sw_num,0)) out_aid_sw_num,
		sum(ifnull(out_aid_ty_num,0)) out_aid_ty_num,sum(ifnull(out_aid_sz_num,0)) out_aid_sz_num,sum(ifnull(out_aid_xa_num,0)) out_aid_xa_num,sum(ifnull(out_aid_nb_num,0)) out_aid_nb_num,
		sum(ifnull(out_aid_yc_num,0)) out_aid_yc_num,sum(ifnull(out_aid_tj_num,0)) out_aid_tj_num,sum(ifnull(out_aid_oth_num,0)) out_aid_oth_num,
		sum(ifnull(out_aid_note,0)) out_aid_note,sum(ifnull(in_aid_cs_num,0)) in_aid_cs_num,sum(ifnull(in_aid_nj_num,0)) in_aid_nj_num,sum(ifnull(in_aid_hz_num,0)) in_aid_hz_num,
		sum(ifnull(in_aid_dl_num,0)) in_aid_dl_num,sum(ifnull(in_aid_qd_num,0)) in_aid_qd_num,sum(ifnull(in_aid_cd_num,0)) in_aid_cd_num,sum(ifnull(in_aid_wh_num,0)) in_aid_wh_num,
		sum(ifnull(in_aid_sw_num,0)) in_aid_sw_num,sum(ifnull(in_aid_ty_num,0)) in_aid_ty_num,sum(ifnull(in_aid_sz_num,0)) in_aid_sz_num,sum(ifnull(in_aid_xa_num,0)) in_aid_xa_num,
		sum(ifnull(in_aid_nb_num,0)) in_aid_nb_num,sum(ifnull(in_aid_yc_num,0)) in_aid_yc_num,sum(ifnull(in_aid_tj_num,0)) in_aid_tj_num,
		sum(ifnull(in_aid_oth_num,0)) in_aid_oth_num,sum(ifnull(in_aid_note,0)) in_aid_note
		FROM BMS_HR_ATTENDENCE_REPORT
		WHERE report_type='计件'
		<if test="factory !=null and factory !=''">
			and factory =#{factory}
		</if>
		<if test="workshop !=null and workshop !='全部'">
			and workshop =#{workshop}
		</if>
		<if test="record_date !=null and record_date !=''">
			and record_date = #{record_date}
		</if>
		GROUP BY factory,workshop
		order by factory,workshop
	</select>

	<select id="queryStaffWorkHoursList" parameterType="Map" resultType="Map">
		select * from (
		select group_concat(tmp.workHoursType,'=',tmp.participationStr order by tmp.staff_number separator '|') workhours,
		tmp.staff_number,tmp.staff_name,
		a.D1,a.D2,a.D3,a.D4,a.D5,a.D6,a.D7,a.D8,a.D9,a.D10,a.D11,a.D12,a.D13,a.D14,a.D15,a.D16,a.D17,a.D18,a.D19,a.D20, a.D21,a.D22,a.D23,a.D24,a.D25,a.D26,a.D27,a.D28,a.D29,a.D30,a.D31 
		from
		( SELECT a.staff_number,a.staff_name,a.workhour_type workHoursType,
		group_concat('\"',substr(a.work_date,9,10),'\":\"',CONCAT(a.sum_participation,'\";') order by work_date separator '') AS participationStr 
		FROM 
		(select '计件' workhour_type,pp.staff_number,pp.staff_name,sum(pp.bus_count) sum_participation,pp.work_date 
		from BMS_HR_PIECE_SALARY pp
		where pp.work_date like CONCAT(#{work_date},'%') and FIND_IN_SET(pp.status,'1,3') and pp.distribution>0
		<if test="factory!='全部'">
			AND pp.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(pp.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND pp.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND pp.team = #{team}
		</if>
		<if test="staff!=''">
			AND (pp.staff_number = #{staff} OR pp.staff_name = #{staff})
		</if>
		GROUP BY pp.staff_number,pp.work_date 
		union all
		select '额外' workhour_type,tp.staff_number,s.name staff_name,sum(tp.work_hour) sum_participation,tp.work_date
		from BMS_HR_STAFF_TMP_HOURS tp left join BMS_HR_STAFF s on tp.staff_number=s.staff_number
		where tp.status='1' and tp.work_date like CONCAT(#{work_date},'%')  
		<if test="factory!='全部'">
			AND tp.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(tp.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND tp.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND tp.team = #{team}
		</if>
		<if test="staff!=''">
			AND (tp.staff_number = #{staff} OR s.name = #{staff})
		</if>
		GROUP BY tp.staff_number,tp.work_date 
		union all
		select '技改' workhour_type,ep.staff_number,s.name staff_name,sum(ep.work_hour) sum_participation,ep.work_date
		from BMS_HR_STAFF_TECH_HOURS ep left join BMS_HR_STAFF s on ep.staff_number=s.staff_number
		where ep.status='1'and ep.work_date like CONCAT(#{work_date},'%')  
		<if test="factory!='全部'">
			AND ep.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(ep.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND ep.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND ep.team = #{team}
		</if>
		<if test="staff!=''">
			AND (ep.staff_number = #{staff} OR s.name = #{staff})
		</if>
		GROUP BY ep.staff_number,ep.work_date 
		union all
		select '等待' workhour_type,wp.staff_number,wp.staff_name,sum(wp.work_hour) sum_participation,wp.work_date
		from BMS_HR_WAIT_SALARY wp
		where wp.work_date like CONCAT(#{work_date},'%') and status in ('1','3') 
		<if test="factory!='全部'">
			AND wp.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(wp.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND wp.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND wp.team = #{team}
		</if>
		<if test="staff!=''">
			AND (wp.staff_number = #{staff} OR wp.staff_name = #{staff})
		</if>
		GROUP BY wp.staff_number,wp.work_date ) a 
		GROUP BY a.staff_number,a.workhour_type) tmp 
		LEFT JOIN BMS_HR_STAFF_ATTENDANCE a ON tmp.staff_number = a.staff_number and a.month=#{work_date}
		  group by tmp.staff_number
		ORDER BY tmp.staff_number,tmp.workHoursType
		) t where workhours is not null
		<if test="start!=null and length!=-1">
			LIMIT #{start} ,#{length}
		</if>	
	</select>
	<select id="queryStaffWorkHoursCount" parameterType="Map" resultType="int">
		select count(1) from (
		select group_concat(tmp.workHoursType,'=',tmp.participationStr order by tmp.staff_number separator '|') workhours,
		tmp.staff_number,tmp.staff_name,
		a.D1,a.D2,a.D3,a.D4,a.D5,a.D6,a.D7,a.D8,a.D9,a.D10,a.D11,a.D12,a.D13,a.D14,a.D15,a.D16,a.D17,a.D18,a.D19,a.D20, a.D21,a.D22,a.D23,a.D24,a.D25,a.D26,a.D27,a.D28,a.D29,a.D30,a.D31 
		from
		( SELECT a.staff_number,a.staff_name,a.workhour_type workHoursType,
		group_concat('\"',substr(a.work_date,9,10),'\":\"',CONCAT(a.sum_participation,'\";') order by work_date separator '') AS participationStr 
		FROM 
		(select '计件' workhour_type,pp.staff_number,pp.staff_name,sum(pp.bus_count) sum_participation,pp.work_date 
		from BMS_HR_PIECE_SALARY pp
		where pp.work_date like CONCAT(#{work_date},'%') and FIND_IN_SET(pp.status,'1,3') and pp.distribution>0
		<if test="factory!='全部'">
			AND pp.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(pp.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND pp.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND pp.team = #{team}
		</if>
		<if test="staff!=''">
			AND (pp.staff_number = #{staff} OR pp.staff_name = #{staff})
		</if>
		GROUP BY pp.staff_number,pp.work_date 
		union all
		select '额外' workhour_type,tp.staff_number,s.name staff_name,sum(tp.work_hour) sum_participation,tp.work_date
		from BMS_HR_STAFF_TMP_HOURS tp left join BMS_HR_STAFF s on tp.staff_number=s.staff_number
		where tp.status='1' and tp.work_date like CONCAT(#{work_date},'%')  
		<if test="factory!='全部'">
			AND tp.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(tp.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND tp.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND tp.team = #{team}
		</if>
		<if test="staff!=''">
			AND (tp.staff_number = #{staff} OR s.name = #{staff})
		</if>
		GROUP BY tp.staff_number,tp.work_date 
		union all
		select '技改' workhour_type,ep.staff_number,s.name staff_name,sum(ep.work_hour) sum_participation,ep.work_date
		from BMS_HR_STAFF_TECH_HOURS ep left join BMS_HR_STAFF s on ep.staff_number=s.staff_number
		where ep.status='1'and ep.work_date like CONCAT(#{work_date},'%')  
		<if test="factory!='全部'">
			AND ep.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(ep.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND ep.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND ep.team = #{team}
		</if>
		<if test="staff!=''">
			AND (ep.staff_number = #{staff} OR s.name = #{staff})
		</if>
		GROUP BY ep.staff_number,ep.work_date 
		union all
		select '等待' workhour_type,wp.staff_number,wp.staff_name,sum(wp.work_hour) sum_participation,wp.work_date
		from BMS_HR_WAIT_SALARY wp
		where wp.work_date like CONCAT(#{work_date},'%') and status in ('1','3') 
		<if test="factory!='全部'">
			AND wp.factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(wp.workshop,#{workshop}) >0
		</if>
		<if test="workgroup!='全部'">
			AND wp.workgroup = #{workgroup}
		</if>
		<if test="team!='全部'">
			AND wp.team = #{team}
		</if>
		<if test="staff!=''">
			AND (wp.staff_number = #{staff} OR wp.staff_name = #{staff})
		</if>
		GROUP BY wp.staff_number,wp.work_date ) a 
		GROUP BY a.staff_number,a.workhour_type) tmp 
		LEFT JOIN BMS_HR_STAFF_ATTENDANCE a ON tmp.staff_number = a.staff_number and a.month=#{work_date}
		  group by tmp.staff_number
		) t where workhours is not null
	</select>
    <select id="getSpecicalSalaryData" parameterType="Map" resultType="Map">
		select * from BMS_HR_SPECIAL_SALARY WHERE 1=1
		<if test="factory!=null and factory!=''">
			AND submit_factory = #{factory}
		</if>
		<if test="workshop!=null and workshop!=''">
			AND FIND_IN_SET(submit_workshop,#{workshop}) >0
		</if>
		<if test="work_month!=null and work_month!=''">
			AND month = #{work_month}
		</if>
        <if test="staff!=null and staff!=''">
			AND (staff_number = #{staff} OR staff_name = #{staff})
		</if>
		<if test="start!=null and length!=-1">
			LIMIT #{start} ,#{length}
		</if>	
	</select>
    <select id="getSpecicalSalaryDataCount" resultType="int" parameterType='Map'>
		select COUNT(1) from BMS_HR_SPECIAL_SALARY WHERE 1=1
		<if test="factory!=''">
			AND submit_factory = #{factory}
		</if>
		<if test="workshop!=''">
			AND FIND_IN_SET(submit_workshop,#{workshop}) >0
		</if>
		<if test="staff!=null and staff!=''">
			AND (staff_number = #{staff} OR staff_name = #{staff})
		</if>
		<if test="work_month!=null and work_month!=''">
			AND month = #{work_month}
		</if>
	</select>
	<insert id="insertSpecialSalary" parameterType="List">
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		<foreach collection="list" index="index" item="item"
			separator=";">
			INSERT INTO BMS_HR_SPECIAL_SALARY(month,staff_number,staff_name,
			plant_org,workshop_org,workgroup_org,team_org,pre_sale_salary,
			after_sale_salary,support_salary,hourly_salary,holiday_salary,
			specical_salary,specical_salary_remark,submit_factory,submit_workshop,status,editor,edit_date
			)
			VALUES(#{item.month},#{item.staff_number},#{item.staff_name},#{item.plant_org}
			,#{item.workshop_org},#{item.workgroup_org},#{item.team_org},#{item.pre_sale_salary}
			,#{item.after_sale_salary},#{item.support_salary},#{item.hourly_salary},#{item.holiday_salary}
			,#{item.specical_salary},#{item.specical_salary_remark},#{item.submit_factory},#{item.submit_workshop},'0',#{item.editor},#{item.edit_date}
			)
		</foreach>
	</insert>
	<update id="deleteSpecialSalary" parameterType='Map'>
		DELETE FROM BMS_HR_SPECIAL_SALARY WHERE 1=1
		<if test="ids!=null and ids!=''">
		   and FIND_IN_SET(id,#{ids})>0
		</if>
		<if test="factoryStr!=null">
		   and FIND_IN_SET(submit_factory,#{factoryStr})>0
		</if>
		<if test="workshopStr">
		   and FIND_IN_SET(submit_workshop,#{workshopStr})>0
		</if>
		<if test="month!=null">
		   and month=#{month}
		</if>
	</update>
</mapper>
