<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.byd.bms.hr.dao.IHrReportDao">
  	
		
	<!-- 查询奖惩汇总信息 -->
	<select id="getRewardsCollectList" resultType="Map"
		parameterType='Map'>
		
		SELECT tmp.*,r.rewards_date,r.reasons,r.add as add_,r.deduct as decuct_,r.group_leader,r.gaffer,r.proposer,r.status 
			FROM 
					(SELECT
							r1.staff_number,s.name,s.workgroup_org,s.team_org,left(r1.rewards_date,7) rewards_month,r1.rewards_factory,r1.rewards_workshop,100
							AS 'fullmark',sum(r1.add) AS `add`,
							SUM(r1.deduct) AS
							deduct,100+ifnull(sum(r1.add),0)-ifnull(SUM(r1.deduct),0) AS mark
							 FROM
							BMS_HR_REWARDS r1
							LEFT JOIN BMS_HR_STAFF s ON r1.staff_number = s.staff_number
							WHERE
							1=1
							and r1.rewards_date LIKE CONCAT(#{rewards_date},'%') 
							<if test="rewards_factory!=null and rewards_factory!=''">
								AND r1.rewards_factory = #{rewards_factory}
							</if>
							<if test="rewards_workshop!=null and rewards_workshop!=''">
								AND r1.rewards_workshop = #{rewards_workshop}
							</if>
							<if test="staff_number!=null">
								AND r1.staff_number LIKE CONCAT('%',#{staff_number},'%') 
								AND (s.staff_number LIKE CONCAT('%',#{staff_number},'%') OR s.name LIKE CONCAT('%',#{staff_number},'%'))
							</if>
							GROUP BY r1.staff_number,left(r1.rewards_date,7),r1.rewards_factory,r1.rewards_workshop
							order by r1.staff_number,left(r1.rewards_date,7),r1.rewards_factory,r1.rewards_workshop
							<if test="start !=null  and length!=-1">
								LIMIT #{start} ,#{length} 
							</if>
							)tmp  
		    LEFT JOIN BMS_HR_REWARDS r 
				ON tmp.staff_number = r.staff_number AND tmp.rewards_month = left(r.rewards_date,7) 
					AND tmp.rewards_factory = r.rewards_factory AND tmp.rewards_workshop = r.rewards_workshop 
			LEFT JOIN BMS_HR_STAFF s1 ON r.staff_number = s1.staff_number
		 WHERE 1=1 
					and	r.rewards_date LIKE CONCAT(#{rewards_date},'%')
				<if test="rewards_factory!=null and rewards_factory!=''">
					AND r.rewards_factory = #{rewards_factory}
				</if>
				<if test="rewards_workshop!=null and rewards_workshop!=''">
					AND r.rewards_workshop = #{rewards_workshop}
				</if>
				<if test="staff_number!=null">
					AND r.staff_number LIKE CONCAT('%',#{staff_number},'%') 
					AND (s1.staff_number LIKE CONCAT('%',#{staff_number},'%') OR s1.name LIKE CONCAT('%',#{staff_number},'%'))
				</if>
				ORDER BY r.staff_number,tmp.rewards_month,tmp.rewards_factory,tmp.rewards_workshop
	</select>
	<select id="getRewardsCollectTotalCount" resultType="int"
		parameterType='Map'>
		SELECT 		count(tmp.staff_number)  FROM (
				SELECT r.staff_number FROM BMS_HR_REWARDS r
				LEFT JOIN BMS_HR_STAFF s ON r.staff_number = s.staff_number
				WHERE  1= 1
				and r.rewards_date LIKE CONCAT('%',#{rewards_date},'%')
				<if test="rewards_factory!=null and rewards_factory!=''">
					AND r.rewards_factory = #{rewards_factory}
				</if>
				<if test="rewards_workshop!=null and rewards_workshop!=''">
					AND r.rewards_workshop = #{rewards_workshop}
				</if>
				<if test="staff_number!=null">
					AND r.staff_number LIKE CONCAT('%',#{staff_number},'%') 
					AND (s.staff_number LIKE CONCAT('%',#{staff_number},'%') OR s.name LIKE CONCAT('%',#{staff_number},'%'))
				</if>
				GROUP BY r.staff_number,left(r.rewards_date,7),r.rewards_factory,r.rewards_workshop )tmp

	</select>
	
	<select id="queryStaffPieceHours" parameterType="Map" resultType="Map">
		<if test="salary_model=='技能系数' or salary_model=='承包制'">
		select ps.*,concat(o.order_no,o.order_name,t.bus_type_code,' ',o.order_qty,'台') order_desc,
		(select round(sum(p.ppay),2) from BMS_HR_PIECE_SALARY p where p.factory=ps.factory and p.workshop=p.workshop
		and p.workgroup=ps.workgroup and p.team=ps.team
		<if test="count_flag=='车辆维度'">
			and p.bus_number=ps.bus_number 
		</if>	
		<if test="count_flag=='人员维度'">
			and p.staff_number=ps.staff_number 
		</if>	
		and locate(substring(#{wdate_start},1,7),p.work_date)>0 and p.salary_model=#{salary_model}) as total_ppay
		from BMS_HR_PIECE_SALARY ps
		left join BMS_OR_ORDER o on ps.order_id=o.id
		left join BMS_BASE_BUS_TYPE t on t.id=o.bus_type_id	
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.salary_model=#{salary_model}
			<if test="workgroup !=null and workgroup !='全部'">
				and ps.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ps.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="bus_number !=null and bus_number !=''">
				and ps.bus_number like concat('%',#{bus_number},'%')
			</if>
			<if test="order_id !=null and order_id !=''">
				and ps.order_id=#{order_id}
			</if>
			<if test="order_no !=null and order_no !=''">
				and o.order_no like concat('%',#{order_no},'%')
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and ps.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and ps.work_date&lt;=#{wdate_end}
			</if>
			<if test="count_flag=='车辆维度'">
				order by ps.bus_number
			</if>	
			<if test="count_flag=='人员维度'">
				order by ps.staff_number
			</if>
			<if test="start !=null and length !='-1' ">
				LIMIT #{start} ,#{length} 
			</if>	
		</if>
		
		<if test="salary_model=='辅助人力' or salary_model=='底薪模式'">
		select h.*,s.name staff_name,s.job,s.basic_salary,ps.ppay,
		(select round(sum(p.ppay),2) from BMS_HR_PIECE_SALARY p where p.factory=h.factory and p.workshop=h.workshop
		and p.workgroup=h.workgroup and p.team=h.team
		<if test="count_flag=='日期维度'">
			and p.work_date=ps.work_date 
		</if>	
		<if test="count_flag=='人员维度'">
			and p.staff_number=h.staff_number 
		</if>	
		and locate(substring(#{wdate_start},1,7),p.work_date)>0 and p.salary_model=#{salary_model}) as total_ppay
		from BMS_HR_STAFF_PIECE_HOURS h
		left join BMS_HR_PIECE_SALARY ps on ps.salary_model=#{salary_model} and h.staff_number=ps.staff_number and h.factory=ps.factory
			and h.workshop=ps.workshop and h.workgroup=ps.workgroup and h.team=ps.team and locate(ps.work_date,h.work_date)>0
		left join BMS_HR_STAFF s on s.staff_number=h.staff_number
		where h.factory=#{factory} and h.workshop=#{workshop} and h.salary_model=#{salary_model}
		<if test="workgroup !=null and workgroup !='全部'">
				and h.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and h.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (h.staff_number like concat('%',#{staff},'%') or s.name like concat('%',#{staff},'%') ) 
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and h.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and h.work_date&lt;=#{wdate_end}
			</if>
			<if test="count_flag=='日期维度'">
				order by h.work_date,h.factory,h.workshop,h.workgroup,h.team
			</if>	
			<if test="count_flag=='人员维度'">
				order by h.staff_number,h.work_date
			</if>
			<if test="start !=null and length !='-1' ">
				LIMIT #{start} ,#{length} 
			</if>
		</if>
		
	</select>
	
	<select id="queryStaffPieceHoursCount" parameterType="Map" resultType="int">
		<if test="salary_model=='技能系数' or salary_model=='承包制'">
		select count(ps.id)
		from BMS_HR_PIECE_SALARY ps
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.salary_model=#{salary_model}
			<if test="workgroup !=null and workgroup !='全部'">
				and ps.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ps.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="bus_number !=null and bus_number !=''">
				and ps.bus_number like concat('%',#{bus_number},'%')
			</if>
			<if test="order_id !=null and order_id !=''">
				and ps.order_id=#{order_id}
			</if>
			<if test="order_no !=null and order_no !=''">
				and o.order_no like concat('%',#{order_no},'%')
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and ps.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and ps.work_date&lt;=#{wdate_end}
			</if>
		</if>
		
		<if test="salary_model=='辅助人力' or salary_model=='底薪模式'">
		select count(h.id)
		from BMS_HR_STAFF_PIECE_HOURS h		
		left join BMS_HR_STAFF s on s.staff_number=h.staff_number
		where h.factory=#{factory} and h.workshop=#{workshop} and h.salary_model=#{salary_model}
		<if test="workgroup !=null and workgroup !='全部'">
				and h.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and h.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (h.staff_number like concat('%',#{staff},'%') or s.name like concat('%',#{staff},'%') ) 
			</if>
			<if test="wdate_start !=null and wdate_start !=''">
				and h.work_date>=#{wdate_start}
			</if>
			<if test="wdate_end !=null and wdate_end !=''">
				and h.work_date&lt;=#{wdate_end}
			</if>
		</if>
	</select>
	
	<select id="queryStaffPieceSalary" parameterType="Map" resultType="Map">
		select st.*,round(sum(ps.ppay),2) piece_pay_total,sum(ps.bus_count) piece_total,sum(ps.bonus) bonus_total,
		ps.salary_model,round(sum(ws.wpay),2) wait_pay_total,sum(ws.work_hour) wwh_total,
		round(sum(ts.real_work_hour*ts.hour_price),2) tmp_pay_total,sum(ts.work_hour) tmpwh_total,
		round(sum(es.real_work_hour*es.hour_price),2) ecn_pay_total,sum(es.work_hour) ecnwh_total,
		s.status,a.attendance_days,sum(r.add-r.deduct) dscore_total, sum(r.add-r.deduct)*5 deduct_pay_total,
		ss.pre_sale_salary,ss.after_sale_salary,ss.support_salary,ss.hourly_salary,ss.holiday_salary,ss.paid_leave_salary,		
		<choose>	
		<when test="workshop=='自制件'">
		(select sum(s.quantity) qty
		from BMS_PD_WORKSHOP_SUPPLY s
		left join BMS_BASE_FACTORY f ON s.factory_id=f.id
		where supply_workshop='自制件' and receive_workshop='部件' 
		and substring(s.supply_date,1,7)=#{month} and f.factory_name=#{factory}) as production_qty
		</when>
		<when test="workshop=='部件'">
		(select sum(pf.online_plan_qty)
		from BMS_PD_PARTS_PLAN_FINISH pf
		left join BMS_BASE_FACTORY f ON pf.factory_id=f.id
		left join BMS_BASE_KEY k on k.value=pf.parts_id and k.key_code='BASE_PARTS'
		where substring(pf.prod_date,1,7)=#{month} and k.key_name='喷砂' and f.factory_name=#{factory}) as output
		</when>	
		<when test="workshop=='焊装'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.welding_offline_date,1,7)=#{month}) as output
		</when>
		<when test="workshop=='涂装'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.painting_offline_date,1,7)=#{month}) as output
		</when>
		<when test="workshop=='底盘'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.chassis_offline_date,1,7)=#{month}) as output
		</when>
		<when test="workshop=='总装'">
		(select count(b.id) 
		from BMS_PLAN_BUS b
		left join BMS_BASE_FACTORY f on b.factory_id=f.id
		where f.factory_name=#{factory} and substring(b.assembly_offline_date,1,7)=#{month}) as output
		</when>
		<otherwise>'' as output</otherwise>
		</choose>
		from(
		select distinct ps.staff_number,ps.staff_name,ps.job,ps.plant_org,ps.workshop_org,ps.workgroup_org,ps.team_org
		from BMS_HR_PIECE_SALARY ps
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ps.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ps.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ws.staff_number,ws.staff_name,ws.job,ws.plant_org,ws.workshop_org,ws.workgroup_org,ws.team_org
		from BMS_HR_WAIT_SALARY ws
		where ws.factory=#{factory} and ws.workshop=#{workshop}  and ws.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ws.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ws.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ts.staff_number,ts.staff_name,ts.job,ts.plant_org,ts.workshop_org,ts.workgroup_org,ts.team_org
		from BMS_HR_TMP_SALARY ts
		where ts.factory=#{factory} and ts.workshop=#{workshop} and ts.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ts.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ts.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ts.staff_number like concat('%',#{staff},'%') or ts.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct es.staff_number,es.staff_name,es.job,es.plant_org,es.workshop_org,es.workgroup_org,es.team_org
		from BMS_HR_TECH_SALARY es
		where es.factory=#{factory} and es.workshop=#{workshop} and es.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and es.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and es.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (es.staff_number like concat('%',#{staff},'%') or es.staff_name like concat('%',#{staff},'%') )
		</if>
		) st
		left join BMS_HR_STAFF s on s.staff_number=st.staff_number
		left join BMS_HR_PIECE_SALARY ps on ps.factory=#{factory} and ps.workshop=#{workshop} 
		and st.staff_number=ps.staff_number and ps.work_date like concat(#{month},'%')
		left join BMS_HR_WAIT_SALARY ws on ws.staff_number=st.staff_number
		and ws.factory=#{factory}  and ws.workshop=#{workshop} and ws.work_date like concat(#{month},'%')
		left join BMS_HR_TMP_SALARY ts on ts.factory=#{factory} and ts.workshop=#{workshop} 
		and ts.staff_number=st.staff_number and ts.work_date like concat(#{month},'%')
		left join BMS_HR_TECH_SALARY es on es.factory=#{factory} and es.workshop=#{workshop} 
		and es.staff_number=st.staff_number and es.work_date like concat(#{month},'%')
		left join BMS_HR_STAFF_ATTENDANCE a on a.staff_number=st.staff_number and a.month=#{month}
		left join BMS_HR_REWARDS r on r.staff_number=st.staff_number
		left join BMS_HR_SPECIAL_SALARY ss on ss.staff_number=st.staff_number and ss.submit_factory=#{factory} and ss.submit_workshop=#{workshop}
		group by staff_number
		order by workgroup_org,team_org,salary_model
	</select>
	
	<select id="queryStaffPieceSalaryHistory" parameterType="Map" resultType="Map">
		select s.status staff_status,sh.*
		from BMS_HR_PIECE_SALARY_HISTORY sh
		left join (
		select distinct ps.staff_number,ps.staff_name
		from BMS_HR_PIECE_SALARY ps
		where ps.factory=#{factory} and ps.workshop=#{workshop} and ps.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ps.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ps.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ps.staff_number like concat('%',#{staff},'%') or ps.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ws.staff_number,ws.staff_name
		from BMS_HR_WAIT_SALARY ws
		where ws.factory=#{factory} and ws.workshop=#{workshop}  and ws.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ws.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ws.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct ts.staff_number,ts.staff_name
		from BMS_HR_TMP_SALARY ts
		where ts.factory=#{factory} and ts.workshop=#{workshop} and ts.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and ts.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ts.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ts.staff_number like concat('%',#{staff},'%') or ts.staff_name like concat('%',#{staff},'%') )
		</if>
		union
		select distinct es.staff_number,es.staff_name
		from BMS_HR_TECH_SALARY es
		where es.factory=#{factory} and es.workshop=#{workshop} and es.work_date like concat(#{month},'%')
		<if test="workgroup !=null and workgroup !='全部'">
			and es.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and es.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (es.staff_number like concat('%',#{staff},'%') or es.staff_name like concat('%',#{staff},'%') )
		</if>
		) st on st.staff_number=sh.staff_number
		left join BMS_HR_STAFF s on s.staff_number=sh.staff_number
		where sh.month=#{month} and sh.submit_factory=#{factory} and sh.submit_workshop=#{workshop}
		<if test="staff !=null and staff !=''">
		and (st.staff_number like concat('%',#{staff},'%') or st.staff_name like concat('%',#{staff},'%') )
		</if>
	
	</select>
	
	<select id="queryStaffPieceSalaryToBal" parameterType="Map" resultType="Map">
		select s.status staff_status,sh.*
		from BMS_HR_PIECE_SALARY_HISTORY sh
		left join BMS_HR_STAFF s on s.staff_number=sh.staff_number
		where sh.month=#{month} and s.plant_org=#{factory} and s.workshop_org=#{workshop}
		<if test="workgroup !=null and workgroup !='全部'">
		 and s.workgroup_org=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
		 and s.team_org=#{team}
		</if>
		<if test="staff !=null and staff !=''">
		and (s.staff_number like concat('%',#{staff},'%') or s.staff_name like concat('%',#{staff},'%') )
		</if>
	
	</select>
	
	<insert id="saveSubmitStaffSalary" parameterType="Map" >
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		insert into BMS_HR_PIECE_SALARY_HISTORY 
		(month,staff_number,staff_name,job,plant_org,workshop_org,workgroup_org,team_org,
		attendance_days,piece_total,bonus_total,piece_pay_total,ecnwh_total,ecn_pay_total,wwh_total,wait_pay_total,tmpwh_total,tmp_pay_total,
		dscore_total,deduct_pay_total,pre_sale_salary,after_sale_salary,paid_leave_salary,holiday_salary,hourly_salary,support_salary,
		saver,save_date,submit_factory,submit_workshop,status,production_qty
		) 
		values 
		<foreach collection="staff_salary_list" item="detail" index="index" separator=",">
		(#{month},#{detail.staff_number},#{detail.staff_name},#{detail.job},#{detail.plant_org},#{detail.workshop_org},#{detail.workgroup_org},#{detail.team_org},#{detail.attendance_days},
		#{detail.piece_total},#{detail.bonus_total},#{detail.piece_pay_total},#{detail.ecnwh_total},#{detail.ecn_pay_total},#{detail.wwh_total},#{detail.wait_pay_total},#{detail.tmpwh_total},#{detail.tmp_pay_total},
		#{detail.dscore_total},#{detail.deduct_pay_total},#{detail.pre_sale_salary},#{detail.after_sale_salary},#{detail.paid_leave_salary},#{detail.holiday_salary},#{detail.hourly_salary},#{detail.support_salary},
		#{saver},#{save_date},#{factory},#{workshop},'已提交',#{detail.production_qty}
		)
		</foreach>
	</insert>
	
	<select id="getEcnReportData" parameterType="Map" resultType="Map">
		SELECT task_number,task_content,workshop,total_hours AS totalhours,total_hours*hour_price AS totalprice,
		work_date,staff_number,staff_name,job,workshop_org,workgroup_org,team_org,round(work_hour,4) AS work_hour,
		round(hour_price*work_hour,4) AS salary,plant_org,round(real_work_hour,4) AS real_work_hour
		FROM BMS_HR_TECH_SALARY
		WHERE
		1=1
		<if test="factory !=null and factory !=''">
			and factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and find_in_set(workshop,#{workshop})>0
		</if>
		<if test="workgroup !=null and workgroup !=''">
			and workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !=''">
			and team=#{team}
		</if>
		<if test="dateStart !=null and dateStart !=''">
			<![CDATA[
			and work_date>=#{dateStart}
			]]>
		</if>
		<if test="dateEnd !=null and dateEnd !=''">
			<![CDATA[
			and work_date<=#{dateEnd}
			]]>
		</if>
		<if test="staff !=null and staff !=''">
			<![CDATA[
			and (staff_number like CONCAT('%',#{staff},'%') or staff_name like CONCAT('%',#{staff},'%'))
			]]>
		</if>
		<if test="ecn_document_number !=null and ecn_document_number !=''">
			<![CDATA[
			and ecn_document_number like CONCAT('%',#{ecn_document_number},'%')
			]]>
		</if>
		<if test="task !=null and task !=''">
			<![CDATA[
			and task_content like CONCAT('%',#{task},'%')
			]]>
		</if>
		order by
		task_number asc,
		work_date asc
	</select>
	
	<select id="queryBalanceSalaryCount" parameterType="Map" resultType="int">
		select count(id) from BMS_HR_PIECE_SALARY_HISTORY sh
		where sh.status in ('已提交','已驳回')
		<if test="factory !=null and factory !=''">
			and sh.submit_factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and sh.submit_workshop=#{workshop}
		</if>
		<foreach collection="staff_salary_list" item="detail" open=" and sh.staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and sh.month=#{month}
		</if>
		
	</select>
	
	<select id="queryBalanceStaffSalary" parameterType="Map" resultType="Map">
		select sh.staff_number,sh.submit_factory,sh.submit_workshop,sh.month from BMS_HR_PIECE_SALARY_HISTORY sh
		where sh.status = '已结算'
		<if test="factory !=null and factory !=''">
			and sh.submit_factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and sh.submit_workshop=#{workshop}
		</if>
		<foreach collection="staff_salary_list" item="detail" open=" and sh.staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and sh.month=#{month}
		</if>
		
	</select>
	
	<delete id="deletePieceSalaryHistory" parameterType="Map">
		delete from BMS_HR_PIECE_SALARY_HISTORY where status in ('已提交','已驳回')
		<if test="factory !=null and factory !=''">
			and submit_factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !=''">
			and submit_workshop=#{workshop}
		</if>
		<foreach collection="staff_salary_list" item="detail" open=" and staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and month=#{month}
		</if>
	</delete>
	<select id="queryStaffWaitHours" parameterType="Map" resultType="Map">
		select * from BMS_HR_WAIT_SALARY ws where status in ('1','3') and 1=1
		    <if test="factory !=null and factory !='全部'">
				and ws.factory=#{factory}
			</if>
			<if test="workshop !=null and workshop !='全部'">
				and ws.workshop=#{workshop}
			</if>
			<if test="workgroup !=null and workgroup !='全部'">
				and ws.workgroup=#{workgroup}
			</if>
			<if test="team !=null and team !='全部'">
				and ws.team=#{team}
			</if>
			<if test="staff !=null and staff !=''">
				and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') ) 
			</if>
			<if test="waitdate !=null and waitdate !=''">
				and ws.work_date LIKE CONCAT('%',#{waitdate},'%')
			</if>
			<if test="start !=null and length !='' ">
				LIMIT #{start} ,#{length} 
			</if>	
	</select>
	
	<select id="queryStaffWaitHoursCount" parameterType="Map" resultType="int">
		select count(1) from BMS_HR_WAIT_SALARY ws where status in ('1','3') and 1=1
	    <if test="factory !=null and factory !='全部'">
			and ws.factory=#{factory}
		</if>
		<if test="workshop !=null and workshop !='全部'">
			and ws.workshop=#{workshop}
		</if>
		<if test="workgroup !=null and workgroup !='全部'">
			and ws.workgroup=#{workgroup}
		</if>
		<if test="team !=null and team !='全部'">
			and ws.team=#{team}
		</if>
		<if test="staff !=null and staff !=''">
			and (ws.staff_number like concat('%',#{staff},'%') or ws.staff_name like concat('%',#{staff},'%') ) 
		</if>
		<if test="waitdate !=null and waitdate !=''">
			and ws.work_date LIKE CONCAT('%',#{waitdate},'%')
		</if>
	</select>
	<update id="updateStaffSalaryStatus" parameterType="Map">
		update BMS_HR_PIECE_SALARY_HISTORY set status=#{status},calculator=#{saver},calculate_date=#{save_date}
		where submit_factory=#{factory} and submit_workshop=#{workshop}
		<foreach collection="staff_salary_list" item="detail" open=" and staff_number in(" close=")" index="index" separator=",">
			#{detail.staff_number}
		</foreach>
		<if test="month !=null and month !=''">
			and month=#{month}
		</if>
	</update>
</mapper>
